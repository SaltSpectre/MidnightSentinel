name: Build MSI Installers

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-msi:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore src/MidnightSentinel.sln

    - name: Build application
      run: dotnet build src/MidnightSentinel.sln --configuration Release --runtime win-${{ matrix.arch }} --no-restore

    - name: Publish application
      run: dotnet publish src/MidnightSentinel.csproj --configuration Release --runtime win-${{ matrix.arch }} --self-contained true -p:PublishSingleFile=false -p:PublishReadyToRun=true --output publish/${{ matrix.arch }}

    - name: Setup WiX Toolset
      run: |
        dotnet tool install --global wix --version 4.0.5
        wix extension add WixToolset.Heat.wixext/4.0.5
        wix extension add WixToolset.Util.wixext/4.0.5
        wix extension add WixToolset.UI.wixext/4.0.5

    - name: Harvest published files
      run: |
        wix heat dir publish/${{ matrix.arch }} -cg PublishedFiles -dr INSTALLFOLDER -gg -sfrag -srd -out installer/HarvestedFiles.wxs

    - name: Build WiX MSI
      run: |
        wix build -arch ${{ matrix.arch }} -ext WixToolset.Util.wixext -ext WixToolset.UI.wixext -out MidnightSentinel-${{ matrix.arch }}.msi installer/Product.wxs installer/HarvestedFiles.wxs

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: MidnightSentinel-${{ matrix.arch }}-msi
        path: MidnightSentinel-${{ matrix.arch }}.msi
        retention-days: 90

    - name: Upload to Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: MidnightSentinel-${{ matrix.arch }}.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
