<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="Midnight Sentinel"
           Language="1033"
           Version="$(Version)"
           Manufacturer="SaltSpectre"
           UpgradeCode="A9E8B7C6-5D4E-3F2A-1B0C-9D8E7F6A5B4C"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perUser">

    <SummaryInformation Description="OLED Screen Burn-in Protection - Midnight Sentinel creates full-screen overlays to protect OLED screens from burn-in" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" 
             Title="Midnight Sentinel" 
             Level="1" 
             Display="expand" 
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAbsent="no"
             AllowAdvertise="no"
             Description="The main Midnight Sentinel application (required).">
      <ComponentGroupRef Id="PublishedFiles" />
      <ComponentRef Id="ApplicationShortcutComponent" />
      
      <Feature Id="PathFeature" 
               Title="PATH Registration" 
               Level="1"
               AllowAdvertise="no"
               Description="Adds Midnight Sentinel to your PATH environment variable for easy command-line access.">
        <ComponentRef Id="PathEnvironmentComponent" />
      </Feature>
      
      <Feature Id="AutoStartFeature" 
               Title="Auto start at logon" 
               Level="1"
               AllowAdvertise="no"
               Description="Automatically starts Midnight Sentinel when you log in to Windows.">
        <ComponentRef Id="AutoStartComponent" />
      </Feature>
    </Feature>

    <Icon Id="ProductIcon" SourceFile="../src/Resources/MidnightSentinel.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/SaltSpectre/MidnightSentinel" />

    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <ui:WixUI Id="WixUI_FeatureTree" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="ManufacturerFolder" Name="SaltSpectre">
        <Directory Id="INSTALLFOLDER" Name="Midnight Sentinel" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ManufacturerProgramsFolder" Name="SaltSpectre">
        <Directory Id="ApplicationProgramsFolder" Name="Midnight Sentinel" />
      </Directory>
    </StandardDirectory>

  </Package>

  <Fragment>
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcutComponent" Guid="B3A4C8D1-2E5F-4A6B-9C7D-8E1F2A3B4C5D">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Midnight Sentinel"
                  Description="OLED Screen Burn-in Protection"
                  Target="[INSTALLFOLDER]midsent.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="ProductIcon" />
        <Shortcut Id="UninstallProduct"
                  Name="Uninstall Midnight Sentinel"
                  Description="Uninstalls Midnight Sentinel"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RemoveFolder Id="CleanUpManufacturerPrograms" Directory="ManufacturerProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
                       Key="Software\SaltSpectre\MidnightSentinel"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="PathEnvironmentComponent" Guid="C5D6E7F8-9A0B-1C2D-3E4F-5A6B7C8D9E0F">
        <Environment Id="PathEnvironment"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="no" />
        <CreateFolder />
        <RegistryValue Root="HKCU"
                       Key="Software\SaltSpectre\MidnightSentinel"
                       Name="PathSet"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="AutoStartComponent" Guid="D6E7F8A9-0B1C-2D3E-4F5A-6B7C8D9E0F1A">
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\Windows\CurrentVersion\Run"
                       Name="MidnightSentinel"
                       Type="string"
                       Value="&quot;[INSTALLFOLDER]midsent.exe&quot;"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

</Wix>
